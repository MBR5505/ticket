<%- contentFor('body') %>

<div class="dashboard-container">
  <!-- Left Navbar -->
  <nav class="navbar">
    <div class="navbar-header">
      <div class="logo">
        <i class="fas fa-headset"></i>
        <span class="logo-text">Helpdesk</span>
      </div>
      <div class="navbar-toggle">
        <i class="fas fa-bars"></i>
      </div>
    </div>
    
    <div class="navbar-items">
      <!-- Admin Navigation -->
      <a href="/admin/dashboard" class="navbar-item active">
        <i class="fas fa-home"></i>
        <span>Dashboard</span>
      </a>
      <a href="/admin/tickets" class="navbar-item">
        <i class="fas fa-ticket-alt"></i>
        <span>All Tickets</span>
      </a>
      <a href="/admin/statistics" class="navbar-item">
        <i class="fas fa-chart-bar"></i>
        <span>Statistics</span>
      </a>
      <% if (user.role === 'head_admin') { %>
        <a href="#" class="navbar-item" data-panel="notifications-panel">
          <i class="fas fa-bell"></i>
          <span>Notifications</span>
        </a>
        <a href="/admin/users" class="navbar-item">
          <i class="fas fa-users"></i>
          <span>Users</span>
        </a>
      <% } %>
      <a href="#" class="navbar-item" data-panel="settings-panel">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </a>
      
      <!-- Logout -->
      <a href="/auth/logout" class="navbar-item">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
      </a>
    </div>
  </nav>
  
  <!-- Main Content -->
  <div class="main-content">
    <!-- Left Panel (My Tickets) -->
    <div class="panel left-panel">
      <div class="panel-header">
        <h2>My Assigned Tickets</h2>
        <div class="panel-actions">
          <div class="search-filter">
            <input type="text" id="search-tickets" placeholder="Search tickets...">
            <select id="filter-status">
              <option value="all">All Status</option>
              <option value="open">Open</option>
              <option value="in_progress">In Progress</option>
              <option value="resolved">Resolved</option>
            </select>
          </div>
        </div>
      </div>
      <div class="panel-content">
        <% if (myTickets && myTickets.length > 0) { %>
          <div class="tickets-table-container">
            <table class="tickets-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>User</th>
                  <th>Status</th>
                  <th>Priority</th>
                  <th>Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% myTickets.forEach(ticket => { %>
                  <tr class="ticket-row <%= ticket.status %>">
                    <td><%= ticket._id.toString().slice(-6).toUpperCase() %></td>
                    <td><%= ticket.title %></td>
                    <td><%= ticket.user.name %></td>
                    <td>
                      <span class="status-badge <%= ticket.status %>">
                        <%= ticket.status === 'open' ? 'Open' : 
                           ticket.status === 'in_progress' ? 'In Progress' : 
                           'Resolved' %>
                      </span>
                    </td>
                    <td>
                      <span class="priority-badge <%= ticket.priority %>">
                        <%= ticket.priority.charAt(0).toUpperCase() + ticket.priority.slice(1) %>
                      </span>
                    </td>
                    <td><%= formatTime(ticket.updatedAt) %></td>
                    <td>
                      <a href="/tickets/admin/<%= ticket._id %>" class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i> View
                      </a>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="empty-state">
            <div class="empty-icon">
              <i class="fas fa-clipboard-list"></i>
            </div>
            <h3>No Assigned Tickets</h3>
            <p>You don't have any tickets assigned to you yet.</p>
          </div>
        <% } %>
      </div>
    </div>
    
    <!-- Panel Divider -->
    <div class="panel-divider">
      <span class="divider-icon">⋮⋮</span>
    </div>
    
    <!-- Right Panel (Open Tickets) -->
    <div class="panel right-panel">
      <div class="panel-header">
        <h2>Open Tickets</h2>
      </div>
      <div class="panel-content">
        <% if (openTickets && openTickets.length > 0) { %>
          <div class="tickets-table-container">
            <table class="tickets-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>User</th>
                  <th>Category</th>
                  <th>Priority</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% openTickets.forEach(ticket => { %>
                  <tr class="ticket-row open">
                    <td><%= ticket._id.toString().slice(-6).toUpperCase() %></td>
                    <td><%= ticket.title %></td>
                    <td><%= ticket.user.name %></td>
                    <td><%= ticket.category %></td>
                    <td>
                      <span class="priority-badge <%= ticket.priority %>">
                        <%= ticket.priority.charAt(0).toUpperCase() + ticket.priority.slice(1) %>
                      </span>
                    </td>
                    <td><%= formatTime(ticket.createdAt) %></td>
                    <td>
                      <a href="/tickets/admin/<%= ticket._id %>" class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i> View
                      </a>
                      <button class="btn btn-sm btn-secondary assign-to-me" data-ticket-id="<%= ticket._id %>">
                        <i class="fas fa-user-check"></i> Assign to me
                      </button>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
          
          <div class="view-all-link">
            <a href="/admin/tickets" class="btn btn-outline">View All Open Tickets</a>
          </div>
        <% } else { %>
          <div class="empty-state">
            <div class="empty-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <h3>No Open Tickets</h3>
            <p>There are no unassigned open tickets at the moment.</p>
          </div>
        <% } %>
        
        <div class="active-chats">
          <h3>Active User Chats</h3>
          
          <% if (chats && chats.length > 0) { %>
            <div class="chat-list">
              <% chats.forEach(chat => { %>
                <div class="chat-item <%= chat.active ? 'active' : '' %>">
                  <div class="chat-avatar">
                    <%= chat.user ? chat.user.name.charAt(0).toUpperCase() : '?' %>
                  </div>
                  <div class="chat-details">
                    <div class="chat-header">
                      <h4><%= chat.user ? chat.user.name : 'Unknown User' %></h4>
                      <span class="chat-time"><%= formatTime(chat.updatedAt) %></span>
                    </div>
                    <p class="chat-preview"><%= chat.lastMessage %></p>
                  </div>
                  <% if (chat.unreadCount > 0) { %>
                    <div class="unread-badge"><%= chat.unreadCount %></div>
                  <% } %>
                </div>
              <% }); %>
            </div>
            
            <div class="view-all-link">
              <a href="/admin/messages" class="btn btn-outline">View All Messages</a>
            </div>
          <% } else { %>
            <div class="empty-chats">
              <p>No active conversations at the moment.</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Third Panel for notifications/settings -->
  <div class="third-panel">
    <div class="third-panel-header">
      <h3 class="panel-title">Panel Title</h3>
      <div class="close-panel">
        <i class="fas fa-times"></i>
      </div>
    </div>
    <div class="third-panel-content">
      <!-- Notifications panel -->
      <div id="notifications-panel" style="display: none;">
        <div class="notifications-list">
          <!-- Notification items will be added dynamically -->
          <div class="empty-notifications">
            <p>You have no new notifications.</p>
          </div>
        </div>
      </div>
      
      <!-- Settings panel -->
      <div id="settings-panel" style="display: none;">
        <h3>Theme Settings</h3>
        <div class="settings-section">
          <div class="theme-selector">
            <button class="theme-btn light-theme" data-theme="light">
              <i class="fas fa-sun"></i> Light
            </button>
            <button class="theme-btn dark-theme" data-theme="dark">
              <i class="fas fa-moon"></i> Dark
            </button>
          </div>
        </div>
        
        <h3>Account Settings</h3>
        <div class="settings-section">
          <p>Visit the <a href="/user/settings">Settings Page</a> to update your profile and account settings.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<% contentFor('script') %>
<script src="/socket.io/socket.io.js"></script>
<script src="/js/dashboard.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('search-tickets');
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        filterTickets(searchTerm, document.getElementById('filter-status').value);
      });
    }
    
    // Filter by status dropdown
    const filterStatus = document.getElementById('filter-status');
    if (filterStatus) {
      filterStatus.addEventListener('change', function() {
        filterTickets(searchInput.value.toLowerCase(), this.value);
      });
    }
    
    // Assign to me buttons
    const assignButtons = document.querySelectorAll('.assign-to-me');
    assignButtons.forEach(button => {
      button.addEventListener('click', function() {
        const ticketId = this.getAttribute('data-ticket-id');
        assignTicketToMe(ticketId);
      });
    });
    
    // Chat items click
    const chatItems = document.querySelectorAll('.chat-item');
    chatItems.forEach(item => {
      item.addEventListener('click', function() {
        // Here you would normally redirect to the chat page
        // For now, we'll just show a notification
        if (window.notifications) {
          window.notifications.info('Chat functionality coming soon!');
        }
      });
    });
    
    // Theme selector
    const themeButtons = document.querySelectorAll('.theme-btn');
    themeButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        const theme = this.getAttribute('data-theme');
        setTheme(theme);
      });
    });
  });
  
  function filterTickets(searchTerm, status) {
    const rows = document.querySelectorAll('.ticket-row');
    
    rows.forEach(row => {
      const title = row.cells[1].textContent.toLowerCase();
      const id = row.cells[0].textContent.toLowerCase();
      const user = row.cells[2].textContent.toLowerCase();
      const rowStatus = row.className.includes('open') ? 'open' :
                        row.className.includes('in_progress') ? 'in_progress' :
                        'resolved';
      
      const matchesSearch = title.includes(searchTerm) || 
                           id.includes(searchTerm) || 
                           user.includes(searchTerm);
                           
      const matchesStatus = status === 'all' || rowStatus === status;
      
      if (matchesSearch && matchesStatus) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }
  
  function assignTicketToMe(ticketId) {
    if (!ticketId) return;
    
    fetch(`/tickets/${ticketId}/assign`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ adminId: '<%= user._id %>' })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          if (window.notifications) {
            window.notifications.success('Ticket assigned to you successfully');
          }
          
          // Refresh the page to update the ticket lists
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          if (window.notifications) {
            window.notifications.error(data.message);
          }
        }
      })
      .catch(error => {
        console.error('Error assigning ticket:', error);
        if (window.notifications) {
          window.notifications.error('An error occurred while assigning the ticket');
        }
      });
  }
  
  function setTheme(theme) {
    document.body.setAttribute('data-theme', theme);
    
    // Save preference to user settings
    fetch('/user/settings/update', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ theme })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          if (window.notifications) {
            window.notifications.success('Theme updated successfully');
          }
        }
      })
      .catch(error => {
        console.error('Error updating theme:', error);
      });
  }
</script>
